package com.lot86.practice_app_backend.shopping.service;

import com.lot86.practice_app_backend.entity.AppUser;
import com.lot86.practice_app_backend.group.entity.AppGroup;
import com.lot86.practice_app_backend.group.entity.GroupMember;
import com.lot86.practice_app_backend.group.repo.GroupMemberRepository;
import com.lot86.practice_app_backend.inventory.dto.ItemCreateRequest;
import com.lot86.practice_app_backend.inventory.dto.ItemResponse;
import com.lot86.practice_app_backend.inventory.entity.Item;
import com.lot86.practice_app_backend.inventory.repo.ItemRepository;
import com.lot86.practice_app_backend.inventory.service.ItemService;
import com.lot86.practice_app_backend.notification.service.NotificationService;
import com.lot86.practice_app_backend.repo.AppGroupRepository;
import com.lot86.practice_app_backend.repo.AppUserRepository;
import com.lot86.practice_app_backend.shopping.dto.*;
import com.lot86.practice_app_backend.shopping.entity.ShoppingComment;
import com.lot86.practice_app_backend.shopping.entity.ShoppingItem;
import com.lot86.practice_app_backend.shopping.entity.ShoppingList;
import com.lot86.practice_app_backend.shopping.repo.ShoppingCommentRepository;
import com.lot86.practice_app_backend.shopping.repo.ShoppingItemRepository;
import com.lot86.practice_app_backend.shopping.repo.ShoppingListRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.time.OffsetDateTime;
import java.time.ZoneOffset;
import java.util.List;
import java.util.Optional;
import java.util.UUID;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class ShoppingService {

    private final ShoppingListRepository listRepository;
    private final ShoppingItemRepository shoppingItemRepository; // [명확하게 이름 변경]
    private final AppGroupRepository groupRepository;
    private final AppUserRepository userRepository;
    private final ItemRepository itemRepository; // [명확하게 이름 변경] (재고 아이템용)
    
    private final NotificationService notificationService;
    private final GroupMemberRepository groupMemberRepository;
    private final ItemService itemService;
    private final ShoppingCommentRepository commentRepository;

    /** 1. 쇼핑 리스트 생성 */
    @Transactional
    public ShoppingListResponse createList(UUID groupId, UUID userId, ShoppingListCreateRequest request) {
        AppGroup group = groupRepository.findById(groupId)
                .orElseThrow(() -> new IllegalArgumentException("그룹을 찾을 수 없습니다."));
        AppUser user = userRepository.findById(userId)
                .orElseThrow(() -> new IllegalArgumentException("사용자를 찾을 수 없습니다."));

        ShoppingList newList = new ShoppingList();
        newList.setGroup(group);
        newList.setTitle(request.getTitle());
        newList.setCreatedBy(user);
        
        listRepository.save(newList);
        return ShoppingListResponse.fromEntity(newList, List.of());
    }

    /** 2. 그룹의 쇼핑 리스트 목록 조회 */
    public List<ShoppingListResponse> getGroupLists(UUID groupId) {
        List<ShoppingList> lists = listRepository.findByGroup_GroupIdOrderByCreatedAtDesc(groupId);

        return lists.stream().map(list -> {
            List<ShoppingItem> items = shoppingItemRepository.findByShoppingList_ListId(list.getListId());
            List<ShoppingItemResponse> itemdtos = items.stream()
                    .map(ShoppingItemResponse::fromEntity)
                    .collect(Collectors.toList());
            return ShoppingListResponse.fromEntity(list, itemdtos);
        }).collect(Collectors.toList());
    }

    /** 3. 쇼핑 항목 추가 (스마트 연결 로직 수정됨) */
    @Transactional
    public ShoppingItemResponse addItem(UUID listId, UUID userId, ShoppingItemAddRequest request) {
        ShoppingList list = listRepository.findById(listId)
                .orElseThrow(() -> new IllegalArgumentException("리스트를 찾을 수 없습니다."));
        AppUser user = userRepository.findById(userId)
                .orElseThrow(() -> new IllegalArgumentException("사용자를 찾을 수 없습니다."));

        ShoppingItem shoppingItem = new ShoppingItem();
        shoppingItem.setShoppingList(list);
        shoppingItem.setItemName(request.getItemName());
        shoppingItem.setDesiredQty(request.getDesiredQty());
        shoppingItem.setUnit(request.getUnit());
        shoppingItem.setNote(request.getNote());
        shoppingItem.setAssignee(user);

        UUID groupId = list.getGroup().getGroupId();
        String targetName = request.getItemName();

        // 1. ID로 직접 연결
        if (request.getLinkedItemId() != null) {
            Item inventoryItem = itemRepository.findById(request.getLinkedItemId()).orElse(null);
            shoppingItem.setLinkedItem(inventoryItem);
        } 
        // 2. 방 이름(ID)으로 연결
        else if (request.getLocationId() != null) {
            UUID locId = request.getLocationId();
            
            Optional<Item> existingItem = itemRepository.findByLocation_LocationIdAndStatusNot(locId, "DEPLETED").stream()
                    .filter(i -> i.getName().equals(targetName))
                    .findFirst();

            if (existingItem.isPresent()) {
                shoppingItem.setLinkedItem(existingItem.get());
            } else {
                // 없으면 자동 생성
                ItemCreateRequest newItemReq = new ItemCreateRequest();
                newItemReq.setName(targetName);
                newItemReq.setQuantity(BigDecimal.ZERO);
                newItemReq.setUnit(request.getUnit());
                newItemReq.setLocationId(locId);

                ItemResponse newItemDto = itemService.createItem(groupId, userId, newItemReq);
                Item newItem = itemRepository.findById(newItemDto.getItemId()).orElseThrow();
                shoppingItem.setLinkedItem(newItem);
            }
        }
        // 3. 이름으로 전체 검색
        else {
            Optional<Item> match = itemRepository.findByGroup_GroupIdOrderByCreatedAtDesc(groupId).stream()
                    .filter(i -> i.getName().equals(targetName))
                    .filter(i -> !"DEPLETED".equals(i.getStatus())) 
                    .findFirst();

            if (match.isPresent()) {
                shoppingItem.setLinkedItem(match.get());
            }
        }

        shoppingItemRepository.save(shoppingItem);
        return ShoppingItemResponse.fromEntity(shoppingItem);
    }

    /** 4. 구매 완료 */
    @Transactional
    public void purchaseItem(UUID itemRowId, UUID userId) {
        ShoppingItem item = shoppingItemRepository.findById(itemRowId)
                .orElseThrow(() -> new IllegalArgumentException("항목을 찾을 수 없습니다."));
        AppUser user = userRepository.findById(userId)
                .orElseThrow(() -> new IllegalArgumentException("사용자를 찾을 수 없습니다."));

        if ("PURCHASED".equals(item.getStatus())) {
            throw new IllegalStateException("이미 구매 완료된 항목입니다.");
        }

        item.setStatus("PURCHASED");
        item.setAssignee(user);
        item.setPurchasedQty(item.getDesiredQty());
        item.setPurchasedAt(OffsetDateTime.now(ZoneOffset.UTC));

        sendPurchaseNotification(item, user);
    }

    /** 5. 삭제 */
    @Transactional
    public void deleteItem(UUID itemRowId) {
        shoppingItemRepository.deleteById(itemRowId);
    }

    /** 6. 상태 변경 */
    @Transactional
    public ShoppingListResponse updateListStatus(UUID listId, UUID userId, String newStatus) {
        ShoppingList list = listRepository.findById(listId)
                .orElseThrow(() -> new IllegalArgumentException("리스트를 찾을 수 없습니다."));
        list.setStatus(newStatus);
        if ("CONFIRMED".equals(newStatus)) {
            AppUser user = userRepository.findById(userId)
                    .orElseThrow(() -> new IllegalArgumentException("사용자를 찾을 수 없습니다."));
            list.setConfirmedBy(user);
            list.setConfirmedAt(OffsetDateTime.now());
        }
        List<ShoppingItem> items = shoppingItemRepository.findByShoppingList_ListId(listId);
        List<ShoppingItemResponse> itemDtos = items.stream()
                .map(ShoppingItemResponse::fromEntity)
                .collect(Collectors.toList());
        return ShoppingListResponse.fromEntity(list, itemDtos);
    }
    
    /** 7. 댓글 작성 */
    @Transactional
    public ShoppingCommentResponse addComment(UUID listId, UUID userId, String body) {
        ShoppingList list = listRepository.findById(listId)
                .orElseThrow(() -> new IllegalArgumentException("리스트를 찾을 수 없습니다."));
        AppUser user = userRepository.findById(userId)
                .orElseThrow(() -> new IllegalArgumentException("사용자를 찾을 수 없습니다."));

        ShoppingComment comment = new ShoppingComment();
        comment.setShoppingList(list);
        comment.setAuthor(user);
        comment.setBody(body);

        commentRepository.save(comment);
        return ShoppingCommentResponse.fromEntity(comment);
    }

    /** 8. 댓글 조회 */
    public List<ShoppingCommentResponse> getComments(UUID listId) {
        return commentRepository.findByShoppingList_ListIdOrderByCreatedAtAsc(listId).stream()
                .map(ShoppingCommentResponse::fromEntity)
                .collect(Collectors.toList());
    }

    /** 9. 댓글 삭제 */
    @Transactional
    public void deleteComment(UUID commentId, UUID userId) {
        ShoppingComment comment = commentRepository.findById(commentId)
                .orElseThrow(() -> new IllegalArgumentException("댓글을 찾을 수 없습니다."));
        if (!comment.getAuthor().getUserId().equals(userId)) {
            throw new IllegalStateException("본인이 작성한 댓글만 삭제할 수 있습니다.");
        }
        commentRepository.delete(comment);
    }
    
    /** 10. 항목 수정 */
    @Transactional
    public ShoppingItemResponse updateItem(UUID itemRowId, UUID userId, ShoppingItemUpdateRequest request) {
        ShoppingItem item = shoppingItemRepository.findById(itemRowId)
                .orElseThrow(() -> new IllegalArgumentException("항목을 찾을 수 없습니다."));

        if (request.getDesiredQty() != null) item.setDesiredQty(request.getDesiredQty());
        if (request.getUnit() != null) item.setUnit(request.getUnit());
        if (request.getNote() != null) item.setNote(request.getNote());

        return ShoppingItemResponse.fromEntity(item);
    }

    // 알림 발송 헬퍼
    private void sendPurchaseNotification(ShoppingItem item, AppUser purchaser) {
        try {
            UUID groupId = item.getShoppingList().getGroup().getGroupId();
            List<GroupMember> members = groupMemberRepository.findByGroupId(groupId);
            List<UUID> targetUserIds = members.stream()
                    .map(GroupMember::getUserId)
                    .filter(id -> !id.equals(purchaser.getUserId()))
                    .toList();

            if (targetUserIds.isEmpty()) return;

            List<AppUser> targets = userRepository.findAllById(targetUserIds);
            String title = "구매 완료";
            String body = String.format("'%s'님이 '%s' 구매를 완료했습니다.", purchaser.getName(), item.getItemName());
            for (AppUser target : targets) {
                notificationService.createNotification(target, "PURCHASE_DONE", title, body);
            }
        } catch (Exception e) {
            System.err.println("구매 알림 발송 실패: " + e.getMessage());
        }
    }
    
    /** 11. 리스트 제목 수정 */
    @Transactional
    public ShoppingListResponse updateListTitle(UUID listId, String newTitle) {
        ShoppingList list = listRepository.findById(listId)
                .orElseThrow(() -> new IllegalArgumentException("리스트를 찾을 수 없습니다."));
        list.setTitle(newTitle);

        List<ShoppingItem> items = shoppingItemRepository.findByShoppingList_ListId(listId);
        List<ShoppingItemResponse> itemDtos = items.stream()
                .map(ShoppingItemResponse::fromEntity)
                .collect(Collectors.toList());
        return ShoppingListResponse.fromEntity(list, itemDtos);
    }

    /** 12. 리스트 삭제 */
    @Transactional
    public void deleteList(UUID listId) {
        listRepository.deleteById(listId);
    }

    // [팀원 기능] 그룹 내 아이템 조회
    public List<ShoppingItemResponse> getAllItemsInGroup(UUID groupId) {
        List<ShoppingList> lists = listRepository.findByGroup_GroupIdOrderByCreatedAtDesc(groupId);
        if (lists.isEmpty()) return List.of();

        ShoppingList latestList = lists.get(0);
        List<ShoppingItem> items = shoppingItemRepository.findByShoppingList_ListId(latestList.getListId());
        return items.stream().map(ShoppingItemResponse::fromEntity).collect(Collectors.toList());
    }

    // [팀원 기능] 그룹에 아이템 바로 추가
    @Transactional
    public ShoppingItemResponse addItemToGroup(UUID groupId, UUID userId, ShoppingItemAddRequest request) {
         List<ShoppingList> lists = listRepository.findByGroup_GroupIdOrderByCreatedAtDesc(groupId);
         ShoppingList targetList;
         if (lists.isEmpty()) {
             AppGroup group = groupRepository.findById(groupId).orElseThrow();
             AppUser user = userRepository.findById(userId).orElseThrow();
             targetList = new ShoppingList();
             targetList.setGroup(group);
             targetList.setTitle("기본 장보기 목록");
             targetList.setCreatedBy(user);
             listRepository.save(targetList);
         } else {
             targetList = lists.get(0);
         }
         return addItem(targetList.getListId(), userId, request);
    }
}